<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entry Management - Charging Bull</title>
    <link rel="icon" type="image/jpeg" href="/images/bull.jpg">
    <link rel="stylesheet" href="/css/tailwind.css" />
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <div class="flex h-screen">
      <%- include('partials/sidebar') %>

      <main class="flex-1 overflow-y-auto lg:ml-0">
        <%- include('partials/header', { title: 'Entry Management' }) %>

        <!-- Main Content -->
        <div class="p-4 lg:p-6 animate-fade-in">
          <!-- Page Header with Enhanced Design -->
          <div class="mb-8 lg:mb-10">
            <div class="relative">
              <!-- Background decoration -->
              <div
                class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-indigo-500/10 rounded-3xl transform -rotate-1"
              ></div>
              <div class="relative glass-card rounded-2xl p-6 lg:p-8">
                <div
                  class="flex flex-col lg:flex-row lg:items-center lg:justify-between"
                >
                  <div class="flex items-center gap-4 mb-4 lg:mb-0">
                    <div class="relative">
                      <div
                        class="p-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl text-white shadow-lg"
                      >
                        <i class="fas fa-id-card text-xl"></i>
                      </div>
                      <div class="pulse-ring"></div>
                    </div>
                    <div>
                      <h1
                        class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent"
                      >
                        Entry Management
                      </h1>
                      <p class="text-gray-600 mt-1 text-lg">
                        Manage entries, visitors, and access logs
                      </p>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>
            <!-- Action Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
              <!-- Guest Registration -->
              <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition cursor-pointer">
                <div class="bg-blue-500 text-white rounded-full p-4 mb-3">
                  <i class="fas fa-user-plus fa-2x"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Register Guest</h2>
                <p class="text-gray-500 text-center mb-4">Add a new guest to the system.</p>
                <button onclick="openGuestRegistrationModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Register</button>
              </div>
              
              <!-- Guest Check In -->
              <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition cursor-pointer">
                <div class="bg-green-500 text-white rounded-full p-4 mb-3">
                  <i class="fas fa-user-check fa-2x"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Guest Check In</h2>
                <p class="text-gray-500 text-center mb-4">Verify guest details or status.</p>
                <button onclick="openGuestCheckInModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Check In</button>
              </div>
              
              <!-- Guest Check Out -->
              <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition cursor-pointer">
                <div class="bg-red-500 text-white rounded-full p-4 mb-3">
                  <i class="fas fa-user-minus fa-2x"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Guest Check Out</h2>
                <p class="text-gray-500 text-center mb-4">Process guest departure from premises.</p>
                <button onclick="openGuestCheckoutModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Checkout</button>
              </div>
              
              <!-- Master User Entry -->
              <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition cursor-pointer">
                <div class="bg-purple-500 text-white rounded-full p-4 mb-3">
                  <i class="fas fa-sign-in-alt fa-2x"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Master User Entry</h2>
                <p class="text-gray-500 text-center mb-4">Record master user entry to premises.</p>
                <button onclick="openMasterEntryModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Entry</button>
              </div>
              
              <!-- Master User Exit -->
              <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center hover:shadow-xl transition cursor-pointer">
                <div class="bg-orange-500 text-white rounded-full p-4 mb-3">
                  <i class="fas fa-sign-out-alt fa-2x"></i>
                </div>
                <h2 class="text-xl font-semibold mb-2">Master User Exit</h2>
                <p class="text-gray-500 text-center mb-4">Record master user exit from premises.</p>
                <button onclick="openMasterExitModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">Exit</button>
              </div>
            </div>

          <!-- Current Occupancy Card 
          <div
            class="stat-card p-6 mb-8"
            style="
              background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            "
          >
            <div class="flex items-center justify-between">
              <div>
                <h3
                  class="text-lg lg:text-xl font-bold text-white mb-2 opacity-90"
                >
                  Current Occupancy
                </h3>
                <div class="flex items-center">
                  <span
                    class="text-3xl lg:text-5xl font-bold text-white mr-3"
                    id="currentCount"
                    ><%= currentCount %></span
                  >
                  <span class="text-white opacity-80">people inside</span>
                </div>
              </div>
              <div class="hidden md:block">
                <i class="fas fa-users text-6xl text-white opacity-20"></i>
              </div>
            </div>
            <div class="flex space-x-3 mt-6">
              <button
                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-2 px-4 rounded-xl transition-all duration-200 flex items-center text-sm lg:text-base backdrop-blur-sm"
                onclick="window.location.reload()"
              >
                <i class="fas fa-sync-alt mr-2"></i>
                <span class="hidden sm:inline">Refresh</span>
              </button>
            </div>
          </div>-->

          <!-- Recent Entries Table -->
          <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900">Recent Entries</h3>
              <p class="text-sm text-gray-600">View recent entry/exit records from devices and guest transactions</p>
            </div>
            
            <!-- Search and Filter Bar -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <!-- Search Bar -->
                <div class="lg:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                  <div class="relative">
                    <input
                      type="text"
                      id="entrySearch"
                      placeholder="Search by name or CNIC..."
                      class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <i class="fas fa-search text-gray-400"></i>
                    </div>
                  </div>
                </div>

                <!-- Status Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select
                    id="statusFilter"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  >
                    <option value="">All Status</option>
                    <option value="Check In">Check In</option>
                    <option value="Check Out">Check Out</option>
                  </select>
                </div>

                <!-- User Type Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">User Type</label>
                  <select
                    id="userTypeFilter"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  >
                    <option value="">All Types</option>
                    <option value="Serving Personnel">Serving Personnel</option>
                    <option value="Retired Officer">Retired Officer</option>
                    <option value="Civilian">Civilian</option>
                    <option value="Guest">Guest</option>
                    <option value="Master Entry">Master Entry</option>
                  </select>
                </div>

                <!-- Date From -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                  <input
                    type="date"
                    id="dateFrom"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  />
                </div>

                <!-- Date To -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                  <input
                    type="date"
                    id="dateTo"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  />
                </div>
              </div>

              <!-- Filter Actions -->
              <div class="flex justify-between items-center mt-4">
                <div class="flex space-x-2">
                  <button
                    onclick="applyFilters()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                  >
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                  </button>
                  <button
                    onclick="clearFilters()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                  >
                    <i class="fas fa-times mr-2"></i>Clear
                  </button>
                </div>
                <div id="filterStatus" class="text-sm text-gray-600">
                  <!-- Filter status will be shown here -->
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead>
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S#</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CNIC</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Punch Time</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <% if (entries && entries.length > 0) { %>
                    <% entries.forEach((entry, index) => { %>
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <%= index + 1 %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="flex items-center">
                            <div>
                              <div class="text-sm font-medium text-gray-900"><%- entry.full_name %></div>
                            </div>
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <%= entry.cnic_number %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <% if (entry.type && entry.type !== 'N/A') { %>
                            <% 
                              // Convert to lowercase and trim for comparison
                              const typeValue = entry.type.toLowerCase().trim();
                            %>
                            <% if (typeValue === 'serving personnel') { %>
                              <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">Serving Personnel</span>
                            <% } else if (typeValue === 'retired officer') { %>
                              <span class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-semibold">Retired Officer</span>
                            <% } else if (typeValue === 'civilian') { %>
                              <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">Civilian</span>
                            <% } else if (typeValue === 'guest') { %>
                              <span class="px-3 py-1 rounded-full bg-pink-100 text-pink-700 text-xs font-semibold">
                                <i class="fas fa-user-friends mr-1"></i>Guest
                              </span>
                            <% } else if (typeValue === 'master entry') { %>
                              <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-semibold">
                                <i class="fas fa-users-cog mr-1"></i>Master Entry
                              </span>
                            <% } else { %>
                              <span class="px-3 py-1 rounded-full bg-orange-100 text-orange-700 text-xs font-semibold"><%= entry.type %></span>
                            <% } %>
                          <% } else { %>
                            <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-500 text-xs font-semibold">N/A</span>
                          <% } %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <% if (entry.punch_state_display === 'Check In') { %>
                            <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">Check In</span>
                          <% } else { %>
                            <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">Check Out</span>
                          <% } %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <%= entry.punch_time %>
                        </td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                        No entries found for today
                      </td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>

            <!-- Beautiful Pagination Component -->
            <%- include('components/pagination', { page, pageSize, total, entries }) %>
          </div>

          <!-- Search Results -->
          <div
            id="searchResults"
            class="glass-card p-6 mb-6"
            style="display: none"
          >
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-bold text-gray-900 flex items-center">
                Search Results
              </h4>
              <button
                onclick="hideSearchResults()"
                class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-lg"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="searchResultsContent"></div>
          </div>

          <!-- Current Occupancy Details -->
        </div>
      </main>
    </div>

    <!-- Entry Modal -->
    <%- include('modals/entry-modal') %>

    <!-- Exit Modal -->
    <%- include('modals/exit-modal') %>

    <!-- Unified Person Modal (Register Modal) -->
    <%- include('modals/unified-person-modal') %>

    <!-- Occupancy Details Modal -->
    <%- include('modals/occupancy-modal') %>

    <!-- Search Modal -->
    <%- include('modals/search-modal') %>

    <!-- Guest Registration Modal -->
    <div id="guestRegistrationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Register Guest</h3>
            <button onclick="closeGuestRegistrationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Guest Information Form -->
          <div id="guestInfoForm">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Guest Information</h4>
            <form id="guestRegistrationForm">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                  <input
                    type="text"
                    id="guestFirstName"
                    name="first_name"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                  <input
                    type="text"
                    id="guestLastName"
                    name="last_name"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">CNIC Number</label>
                  <input
                    type="text"
                    id="guestCnic"
                    name="cnic_number"
                    required
                    maxlength="13"
                    pattern="[0-9]{13}"
                    placeholder="1234567890123"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button
                  type="button"
                  onclick="closeGuestRegistrationModal()"
                  class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                >
                  Register Guest
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Guest Check In Modal -->
    <div id="guestCheckInModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Guest Check In</h3>
            <button onclick="closeGuestCheckInModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Step 1: Select Guest -->
          <div id="guestSelectionStep" class="step-content">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-gray-800">Select Guest</h4>
              <button
                onclick="openGuestRegistrationFromCheckIn()"
                class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
              >
                <i class="fas fa-plus mr-1"></i>Register Guest
              </button>
            </div>
            
            <div class="relative mb-4">
              <input
                type="text"
                id="guestSearchInput"
                placeholder="Search guest by name or CNIC..."
                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                oninput="searchGuests(this.value)"
              />
              <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="guestList" class="space-y-3 max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2">
              <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">Loading guests...</p>
              </div>
            </div>
          </div>

          <!-- Step 2: Select Host -->
          <div id="hostSelectionStep" class="step-content hidden">
            <div class="mb-4 p-3 bg-green-50 rounded-lg">
              <p class="text-sm text-gray-600">Selected Guest:</p>
              <p id="selectedGuestName" class="font-semibold text-gray-800"></p>
              <p id="selectedGuestCnic" class="text-sm text-gray-600"></p>
            </div>
            
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Select Host</h4>
            
            <div class="relative mb-4">
              <input
                type="text"
                id="hostSearchInput"
                placeholder="Search host by name or CNIC..."
                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                oninput="searchHosts(this.value)"
              />
              <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="hostList" class="space-y-3 max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2">
              <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">Loading hosts...</p>
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button
                type="button"
                onclick="goBackToGuestSelection()"
                class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
              >
                Back
              </button>
            </div>
          </div>

          <!-- Step 3: Issued Card Number -->
          <div id="cardNumberStep" class="step-content hidden">
            <div class="mb-4 p-3 bg-green-50 rounded-lg">
              <p class="text-sm text-gray-600">Selected Guest:</p>
              <p id="selectedGuestNameFinal" class="font-semibold text-gray-800"></p>
              <p id="selectedGuestCnicFinal" class="text-sm text-gray-600"></p>
              <p class="text-sm text-gray-600 mt-2">Host:</p>
              <p id="selectedHostNameFinal" class="font-semibold text-gray-800"></p>
            </div>
            
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Issued Card Number</h4>
            
            <div class="mb-6">
              <label for="issuedCardNumber" class="block text-sm font-medium text-gray-700 mb-2">
                Card Number <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="issuedCardNumber"
                maxlength="4"
                placeholder="Enter card number (max 4 chars)"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                required
              />
              <p class="text-xs text-gray-500 mt-1">Maximum 4 characters allowed</p>
            </div>

            <div class="flex gap-3 mt-6">
              <button
                type="button"
                onclick="goBackToHostSelection()"
                class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
              >
                Back
              </button>
              <button
                type="button"
                onclick="performCheckIn()"
                class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>Check In
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Guest Checkout Modal -->
    <div id="guestCheckoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Guest Checkout</h3>
            <button onclick="closeGuestCheckoutModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Checked-in Guests List -->
          <div id="checkedInGuestsList">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Select Guest to Checkout</h4>
            
            <div class="relative mb-4">
              <input
                type="text"
                id="checkoutSearchInput"
                placeholder="Search guest by name or host..."
                class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                oninput="searchCheckedInGuests(this.value)"
              />
              <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div id="checkedInList" class="space-y-3 max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-2">
              <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-gray-500">Loading checked-in guests...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Master User Entry Modal -->
    <div id="masterEntryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Master User Entry</h3>
            <button onclick="closeMasterEntryModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Master Entry Form -->
          <div id="masterEntryForm">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Entry Information</h4>
            <form id="masterEntryFormElement">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                  <textarea
                    id="masterEntryDescription"
                    name="description"
                    required
                    rows="3"
                    placeholder="Enter description of the entry..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                  ></textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Number of People</label>
                  <input
                    type="number"
                    id="masterEntryCount"
                    name="people_count"
                    required
                    min="1"
                    max="100"
                    placeholder="Enter number of people"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                </div>
              </div>
              
              <div class="flex gap-3 mt-6">
                <button
                  type="button"
                  onclick="closeMasterEntryModal()"
                  class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
                >
                  Record Entry
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Master User Exit Modal -->
    <div id="masterExitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Master User Exit</h3>
            <button onclick="closeMasterExitModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>

          <!-- Loading State -->
          <div id="masterExitLoading" class="text-center py-8 hidden">
            <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Loading checked-in users...</p>
          </div>

          <!-- No Users State -->
          <div id="masterExitNoUsers" class="text-center py-8 hidden">
            <i class="fas fa-info-circle text-3xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">No users are currently checked in.</p>
          </div>

          <!-- Users List -->
          <div id="masterExitUsersList" class="hidden">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Select User to Check Out</h4>
            
            <!-- Search Bar -->
            <div class="mb-4">
              <div class="relative">
                <input
                  type="text"
                  id="masterExitSearch"
                  placeholder="Search by description..."
                  class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-gray-400"></i>
                </div>
              </div>
            </div>
            
            <div class="max-h-96 overflow-y-auto">
              <div id="checkedInUsersList" class="space-y-3">
                <!-- Users will be loaded here dynamically -->
              </div>
              
              <!-- No Results Message -->
              <div id="noSearchResults" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-search text-2xl mb-2"></i>
                <p>No entries found matching your search.</p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-3 mt-6">
            <button
              type="button"
              onclick="closeMasterExitModal()"
              class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Entry Filtering Functionality
      let originalEntries = [];
      let filteredEntries = [];

      // Store original entries on page load
      document.addEventListener('DOMContentLoaded', function() {
        storeOriginalEntries();
        setupFilterListeners();
      });

      function storeOriginalEntries() {
        const tableRows = document.querySelectorAll('tbody tr');
        originalEntries = [];
        
        tableRows.forEach((row, index) => {
          const cells = row.querySelectorAll('td');
          if (cells.length > 1) { // Skip "No entries found" row
            const nameCell = cells[1].textContent.trim();
            const cnicCell = cells[2].textContent.trim();
            const typeCell = cells[3].textContent.trim();
            const statusCell = cells[4].textContent.trim();
            const timeCell = cells[5].textContent.trim();
            
            originalEntries.push({
              index: index + 1,
              name: nameCell,
              cnic: cnicCell,
              type: typeCell,
              status: statusCell,
              time: timeCell,
              element: row.cloneNode(true)
            });
          }
        });
      }

      function setupFilterListeners() {
        // Real-time search
        document.getElementById('entrySearch').addEventListener('input', function() {
          if (this.value.length > 2 || this.value.length === 0) {
            applyFilters();
          }
        });

        // Filter change listeners
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('userTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('dateFrom').addEventListener('change', applyFilters);
        document.getElementById('dateTo').addEventListener('change', applyFilters);
      }

      function applyFilters() {
        const searchTerm = document.getElementById('entrySearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('userTypeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        filteredEntries = originalEntries.filter(entry => {
          // Search filter (name or CNIC)
          const matchesSearch = searchTerm === '' || 
            entry.name.toLowerCase().includes(searchTerm) || 
            entry.cnic.toLowerCase().includes(searchTerm);

          // Status filter
          const matchesStatus = statusFilter === '' || entry.status.includes(statusFilter);

          // Type filter
          const matchesType = typeFilter === '' || entry.type.includes(typeFilter);

          // Date filter
          let matchesDate = true;
          if (dateFrom || dateTo) {
            const entryDate = parseEntryDate(entry.time);
            if (entryDate) {
              const fromDate = dateFrom ? new Date(dateFrom) : null;
              const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
              
              if (fromDate && entryDate < fromDate) matchesDate = false;
              if (toDate && entryDate > toDate) matchesDate = false;
            }
          }

          return matchesSearch && matchesStatus && matchesType && matchesDate;
        });

        displayFilteredEntries();
        updateFilterStatus();
      }

      function parseEntryDate(timeString) {
        try {
          // Parse the formatted time string back to Date
          // Expected format: "DD/MM/YYYY, HH:MM:SS"
          const parts = timeString.split(', ');
          if (parts.length === 2) {
            const datePart = parts[0].split('/');
            const timePart = parts[1];
            
            if (datePart.length === 3) {
              // Create date string in ISO format: YYYY-MM-DD
              const isoDate = `${datePart[2]}-${datePart[1].padStart(2, '0')}-${datePart[0].padStart(2, '0')}T${timePart}`;
              return new Date(isoDate);
            }
          }
          return new Date(timeString);
        } catch (e) {
          return null;
        }
      }

      function displayFilteredEntries() {
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '';

        if (filteredEntries.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                No entries found matching the current filters
              </td>
            </tr>
          `;
          return;
        }

        filteredEntries.forEach((entry, index) => {
          const row = entry.element.cloneNode(true);
          // Update the index in the first cell
          const firstCell = row.querySelector('td');
          if (firstCell) {
            firstCell.textContent = index + 1;
          }
          tbody.appendChild(row);
        });
      }

      function updateFilterStatus() {
        const statusDiv = document.getElementById('filterStatus');
        const activeFilters = [];
        
        const searchTerm = document.getElementById('entrySearch').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('userTypeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
        if (statusFilter) activeFilters.push(`Status: ${statusFilter}`);
        if (typeFilter) activeFilters.push(`Type: ${typeFilter}`);
        if (dateFrom || dateTo) {
          const dateRange = `${dateFrom || 'Start'} to ${dateTo || 'End'}`;
          activeFilters.push(`Date: ${dateRange}`);
        }

        if (activeFilters.length > 0) {
          statusDiv.innerHTML = `
            <span class="text-blue-600">
              <i class="fas fa-filter mr-1"></i>
              Filtered (${filteredEntries.length}/${originalEntries.length}) | ${activeFilters.join(' | ')}
            </span>
          `;
        } else {
          statusDiv.innerHTML = `
            <span class="text-gray-500">
              Showing ${originalEntries.length} entries
            </span>
          `;
        }
      }

      function clearFilters() {
        document.getElementById('entrySearch').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('userTypeFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        
        filteredEntries = [...originalEntries];
        displayFilteredEntries();
        updateFilterStatus();
      }

      // Set default date to today for convenience
      document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        // Don't set default dates, let user choose
      });
    </script>

    <script src="/js/entry-management.js"></script>
    <script src="/js/modals/entry-modal.js"></script>
    <script src="/js/modals/exit-modal.js"></script>
    <script src="/js/modals/unified-person-modal.js"></script>
    <script src="/js/modals/search-modal.js"></script>
    <script src="/js/modals/guest-registration-modal.js"></script>
    <script src="/js/modals/guest-checkin-modal.js"></script>
    <script src="/js/modals/guest-checkout-modal.js"></script>
    <script src="/js/modals/master-entry-modal.js"></script>
    <script src="/js/modals/master-exit-modal.js"></script>

    <%- include('partials/toast') %> <%- include('partials/enhanced-modal') %>
  </body>
</html>
