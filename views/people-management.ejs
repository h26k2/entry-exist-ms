<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>People Management - Charging Bull</title>
    <link rel="icon" type="image/jpeg" href="/images/bull.jpg">
    <link rel="stylesheet" href="/css/tailwind.css" />
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/people-management.css" />
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen"
  >
    <div class="flex h-screen">
      <%- include('partials/sidebar') %>

      <main class="flex-1 overflow-y-auto">
        <%- include('partials/header', { title: 'People Management' }) %>

        <!-- Main Content -->
        <div class="p-4 lg:p-6 animate-fade-in">
          <!-- Page Header with Enhanced Design -->
          <div class="mb-8 lg:mb-10">
            <div class="relative">
              <!-- Background decoration -->
              <div
                class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 rounded-3xl transform -rotate-1"
              ></div>
              <div class="relative glass-card rounded-2xl p-6 lg:p-8">
                <div
                  class="flex flex-col lg:flex-row lg:items-center lg:justify-between"
                >
                  <div class="flex items-center gap-4 mb-4 lg:mb-0">
                    <div class="relative">
                      <div
                        class="p-3 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl text-white shadow-lg"
                      >
                        <i class="fas fa-users text-xl"></i>
                      </div>
                      <div class="pulse-ring"></div>
                    </div>
                    <div>
                      <h1
                        class="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent"
                      >
                        People Management
                      </h1>
                      <p class="text-gray-600 mt-1 text-lg">
                        Manage people, families, and registration data
                      </p>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
            <div class="stat-card">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Total People
                  </p>
                  <p
                    class="text-2xl lg:text-3xl font-bold text-blue-600"
                    id="totalPeople"
                  >
                    -
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl flex items-center justify-center"
                >
                  <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Active Members
                  </p>
                  <p
                    class="text-2xl lg:text-3xl font-bold text-green-600"
                    id="activeMembers"
                  >
                    -
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-200 rounded-xl flex items-center justify-center"
                >
                  <i class="fas fa-user-check text-green-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Family Groups
                  </p>
                  <p
                    class="text-2xl lg:text-3xl font-bold text-purple-600"
                    id="familyGroups"
                  >
                    -
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl flex items-center justify-center"
                >
                  <i class="fas fa-home text-purple-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="stat-card">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600 mb-1">
                    Recent Additions
                  </p>
                  <p
                    class="text-2xl lg:text-3xl font-bold text-orange-600"
                    id="recentAdditions"
                  >
                    -
                  </p>
                </div>
                <div
                  class="w-12 h-12 bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl flex items-center justify-center"
                >
                  <i class="fas fa-user-plus text-orange-600 text-xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions Grid -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6 mb-8">
            <!-- Add New Person -->
            <button
              class="group glass-card hover:shadow-xl border-2 border-transparent hover:border-blue-200 p-6 transition-all duration-300 text-center"
              onclick="openAddPersonModal()"
            >
              <div
                class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg group-hover:scale-110 transition-transform"
              >
                <i class="fas fa-user-plus text-white text-xl"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-2">
                Add New Person
              </h3>
              <p class="text-sm text-gray-600">
                Register a new person in the system
              </p>
              <div
                class="mt-4 text-blue-600 text-sm font-medium group-hover:text-blue-700"
              >
                <span>Get Started</span>
                <i
                  class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"
                ></i>
              </div>
            </button>

            <!-- Bulk Import -->
            <button
              class="group glass-card hover:shadow-xl border-2 border-transparent hover:border-green-200 p-6 transition-all duration-300 text-center"
              onclick="openBulkImportModal()"
            >
              <div
                class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg group-hover:scale-110 transition-transform"
              >
                <i class="fas fa-upload text-white text-xl"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-2">Bulk Import</h3>
              <p class="text-sm text-gray-600">
                Import multiple people from CSV
              </p>
              <div
                class="mt-4 text-green-600 text-sm font-medium group-hover:text-green-700"
              >
                <span>Upload Data</span>
                <i
                  class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"
                ></i>
              </div>
            </button>

            <!-- Advanced Search -->
            <button
              class="group glass-card hover:shadow-xl border-2 border-transparent hover:border-purple-200 p-6 transition-all duration-300 text-center"
              onclick="openAdvancedSearchModal()"
            >
              <div
                class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg group-hover:scale-110 transition-transform"
              >
                <i class="fas fa-search text-white text-xl"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-900 mb-2">
                Advanced Search
              </h3>
              <p class="text-sm text-gray-600">Search with multiple filters</p>
              <div
                class="mt-4 text-purple-600 text-sm font-medium group-hover:text-purple-700"
              >
                <span>Find People</span>
                <i
                  class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"
                ></i>
              </div>
            </button>
          </div>

          <!-- Search and Filter Section -->
          <div class="glass-card p-6 mb-6">
            <div class="flex items-center space-x-3 mb-6">
              <div
                class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center"
              >
                <i class="fas fa-filter text-white"></i>
              </div>
              <h3 class="text-lg font-bold text-gray-900">Search & Filter</h3>
            </div>

            <div class="flex flex-col lg:flex-row gap-4">
              <!-- Quick Search -->
              <div class="flex-1">
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Quick Search</label
                >
                <div class="relative">
                  <input
                    type="text"
                    id="quickSearch"
                    placeholder="Search by CNIC, name, phone..."
                    class="w-full px-4 py-3 pl-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                  />
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                </div>
              </div>

              <!-- Category Filter -->
              <div class="lg:w-48">
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Category</label
                >
                <select
                  id="categoryFilter"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">All User Categories</option>
                  <% categories.forEach(category => { %>
                  <option value="<%= category.id %>">
                    <%= category.name %>
                  </option>
                  <% }) %>
                </select>
              </div>

              <!-- Status Filter -->
              <div class="lg:w-40">
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Status</label
                >
                <select
                  id="statusFilter"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">All</option>
                  <option value="active">Active</option>
                  <option value="blocked">Blocked</option>
                </select>
              </div>
            </div>
          </div>

          <!-- People Table -->
          <div
            class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"
          >
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">
                  Registered People
                </h3>
                <div class="flex items-center space-x-3">
                  <span class="text-sm text-gray-500"
                    >Total:
                    <span id="totalCount"><%= people.length %></span></span
                  >
                  <button
                    onclick="exportPeopleList()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200"
                  >
                    <i class="fas fa-download mr-2"></i>Export
                  </button>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Person Details
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Contact
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Category
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Status
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Entry History
                    </th>
                    <th
                      class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  class="bg-white divide-y divide-gray-200"
                  id="peopleTableBody"
                >
                  <% people.forEach(person => { %>
                  <tr class="hover:bg-gray-50 transition-colors duration-150">
                    <td class="px-6 py-4">
                      <div class="flex items-center">
                        <div
                          class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3"
                        >
                          <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <div>
                          <div class="text-sm font-semibold text-gray-900">
                            <%= person.name %>
                          </div>
                          <div class="text-xs text-gray-500 font-mono">
                            <%= person.cnic %>
                          </div>
                          <% if (person.is_family_member) { %>
                          <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mt-1"
                          >
                            <i class="fas fa-home mr-1 text-xs"></i>Family
                            Member
                          </span>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-sm text-gray-900">
                        <div><%= person.phone || 'N/A' %></div>
                        <% if (person.emergency_contact) { %>
                        <div class="text-xs text-gray-500 mt-1">
                          Emergency: <%= person.emergency_contact %>
                        </div>
                        <% } %>
                      </div>
                    </td>
                    <td class="px-6 py-4">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                      >
                        <%= person.category_name || 'N/A' %>
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <% if (person.card_number) { %>
                      <div class="flex items-center">
                        <span
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                        >
                          <i class="fas fa-id-card mr-1"></i>Card: <%=
                          person.card_number %>
                        </span>
                      </div>
                      <% } else { %>
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                      >
                        <i class="fas fa-times mr-1"></i>No Card
                      </span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4">
                      <div class="text-sm text-gray-900">
                        <% if (person.family_members_count > 0) { %>
                        <span class="inline-flex items-center text-green-600">
                          <i class="fas fa-users mr-1"></i><%=
                          person.family_members_count %> members
                        </span>
                        <% } else { %>
                        <span class="text-gray-500">None</span>
                        <% } %>
                      </div>
                      <div class="text-xs text-gray-500 mt-1">
                        Registered: <%= new
                        Date(person.created_at).toLocaleDateString() %>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end space-x-2">
                        <button
                          onclick="openPersonDetailsModal('<%= person.id %>')"
                          class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded-lg transition-colors duration-200"
                          title="View Details"
                        >
                          <i class="fas fa-eye"></i>
                        </button>
                        <button
                          onclick="editPerson('<%= person.id %>')"
                          class="text-green-600 hover:text-green-800 p-2 hover:bg-green-50 rounded-lg transition-colors duration-200"
                          title="Edit"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <% if (!person.card_number) { %>
                        <button
                          onclick="generateCard('<%= person.id %>')"
                          class="text-purple-600 hover:text-purple-800 p-2 hover:bg-purple-50 rounded-lg transition-colors duration-200"
                          title="Generate Card"
                        >
                          <i class="fas fa-id-card"></i>
                        </button>
                        <% } %>
                        <button
                          onclick="addFamilyMember('<%= person.id %>')"
                          class="text-orange-600 hover:text-orange-800 p-2 hover:bg-orange-50 rounded-lg transition-colors duration-200"
                          title="Add Family Member"
                        >
                          <i class="fas fa-user-friends"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Unified Person Modal (Add/Edit Person) -->
    <%- include('modals/unified-person-modal', { categories: categories }) %>

    <!-- Person Details Modal -->
    <%- include('modals/person-details-modal') %>

    <!-- Family Member Modal -->
    <%- include('modals/family-member-modal') %>

    <!-- Advanced Search Modal -->
    <%- include('modals/advanced-search-modal', { categories: categories }) %>

    <!-- Bulk Import Modal -->
    <%- include('modals/bulk-import-modal') %>

    <script src="/js/people-management-core.js"></script>
    <script src="/js/modals/unified-person-modal.js"></script>
    <script src="/js/modals/person-details-modal.js"></script>
    <script src="/js/modals/family-member-modal.js"></script>
    <script src="/js/modals/advanced-search-modal.js"></script>
    <script src="/js/modals/bulk-import-modal.js"></script>
    <script>
      // Enhanced modal functionality
      function openBulkImportModal() {
        if (document.getElementById("bulkImportModal")) {
          EnhancedModal.show("bulkImportModal", { size: "lg" });
        }
      }

      function closeBulkImportModal() {
        if (document.getElementById("bulkImportModal")) {
          EnhancedModal.hide("bulkImportModal");
        }
      }

      function openAdvancedSearchModal() {
        if (document.getElementById("advancedSearchModal")) {
          EnhancedModal.show("advancedSearchModal", { size: "lg" });
        }
      }

      function closeAdvancedSearchModal() {
        if (document.getElementById("advancedSearchModal")) {
          EnhancedModal.hide("advancedSearchModal");
        }
      }

      function closePersonDetailsModal() {
        if (document.getElementById("personDetailsModal")) {
          EnhancedModal.hide("personDetailsModal");
        }
      }

      function closeFamilyMemberModal() {
        if (document.getElementById("familyMemberModal")) {
          EnhancedModal.hide("familyMemberModal");
        }
      }

      // Initialize page with enhanced functionality
      document.addEventListener("DOMContentLoaded", function () {
        initializePeoplePage();
      });

      function initializePeoplePage() {
        loadPeopleStats();

        setupEventListeners();
        loadPeopleData();
        updateLastUpdateTime();
      }

      // Load people statistics
      async function loadPeopleStats() {
        try {
          const response = await fetch("/api/people/stats");
          const data = await response.json();

          if (data.success) {
            animateCounter("totalPeople", data.totalPeople || 0);
            animateCounter("activeMembers", data.activeMembers || 0);
            animateCounter("familyGroups", data.familyGroups || 0);
            animateCounter("recentAdditions", data.recentAdditions || 0);
          }
        } catch (error) {
          console.error("Error loading people stats:", error);
        }
      }

      // Enhanced counter animation
      function animateCounter(elementId, finalValue) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const currentValue =
          parseInt(element.textContent.replace(/[^\d]/g, "")) || 0;
        const increment = Math.ceil((finalValue - currentValue) / 20);

        const timer = setInterval(() => {
          const current =
            parseInt(element.textContent.replace(/[^\d]/g, "")) || 0;
          if (current < finalValue) {
            const newValue = Math.min(current + increment, finalValue);
            element.textContent = newValue;
          } else {
            clearInterval(timer);
          }
        }, 50);
      }

      function setupEventListeners() {
        // Family member toggle
        document
          .getElementById("personIsFamilyMember")
          ?.addEventListener("change", function () {
            document.getElementById("personFamilyFields").style.display = this
              .checked
              ? "block"
              : "none";
          });

        // Enhanced search functionality
        document
          .getElementById("quickSearch")
          ?.addEventListener("keyup", debounce(performQuickSearch, 300));
        document
          .getElementById("categoryFilter")
          ?.addEventListener("change", filterPeople);
        document
          .getElementById("statusFilter")
          ?.addEventListener("change", filterPeople);
      }

      // Debounce function for search
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Enhanced search functionality
      async function performQuickSearch() {
        const searchTerm = document.getElementById("quickSearch").value;
        if (searchTerm.length < 2) {
          loadPeopleData();
          return;
        }

        try {
          const response = await fetch(
            `/api/people/search?q=${encodeURIComponent(searchTerm)}`
          );
          const data = await response.json();

          if (data.success) {
            displayPeopleData(data.people);
          }
        } catch (error) {
          console.error("Error searching people:", error);
        }
      }

      async function filterPeople() {
        const category = document.getElementById("categoryFilter").value;
        const status = document.getElementById("statusFilter").value;

        try {
          const params = new URLSearchParams();
          if (category) params.append("category", category);
          if (status) params.append("status", status);

          const response = await fetch(`/api/people?${params.toString()}`);
          const data = await response.json();

          if (data.success) {
            displayPeopleData(data.people);
          }
        } catch (error) {
          console.error("Error filtering people:", error);
        }
      }

      async function loadPeopleData() {
        try {
          const response = await fetch("/api/people");
          const data = await response.json();

          if (data.success) {
            displayPeopleData(data.people);
          }
        } catch (error) {
          console.error("Error loading people data:", error);
        }
      }

      function displayPeopleData(people) {
        const container = document.getElementById("peopleTableBody");
        if (!container) return;

        if (people.length === 0) {
          container.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-500">
                <i class="fas fa-users text-4xl mb-4 opacity-50"></i>
                <p class="text-lg font-medium">No people found</p>
                <p class="text-sm">Try adjusting your search or filters</p>
              </td>
            </tr>
          `;
          return;
        }

        container.innerHTML = people
          .map(
            (person, index) => `
          <tr class="hover:bg-gray-50 transition-all duration-200 animate-fade-in" style="animation-delay: ${
            index * 0.05
          }s">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm">
                  ${person.name.charAt(0).toUpperCase()}
                </div>
                <div class="ml-3">
                  <div class="text-sm font-medium text-gray-900">${
                    person.name
                  }</div>
                  <div class="text-sm text-gray-500">${person.cnic}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
              person.phone || "N/A"
            }</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                ${person.category_name || "N/A"}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${new Date(person.created_at).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                person.is_active
                  ? "bg-green-100 text-green-800"
                  : "bg-red-100 text-red-800"
              }">
                ${person.is_active ? "Active" : "Inactive"}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex items-center space-x-2">
                <button onclick="openPersonDetailsModal(${
                  person.id
                })" class="text-blue-600 hover:text-blue-900 transition-colors" data-tooltip="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button onclick="editPerson(${
                  person.id
                })" class="text-indigo-600 hover:text-indigo-900 transition-colors" data-tooltip="Edit Person">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="generateCard(${
                  person.id
                })" class="text-green-600 hover:text-green-900 transition-colors" data-tooltip="Generate Card">
                  <i class="fas fa-id-card"></i>
                </button>
                <button onclick="addFamilyMember(${
                  person.id
                })" class="text-purple-600 hover:text-purple-900 transition-colors" data-tooltip="Add Family Member">
                  <i class="fas fa-user-plus"></i>
                </button>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      function updateLastUpdateTime() {
        const lastUpdateElement = document.getElementById("lastUpdate");
        if (lastUpdateElement) {
          lastUpdateElement.textContent =
            "Updated " + new Date().toLocaleTimeString();
        }
      }

      // Enhanced notification system
      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        const bgColor = {
          success: "bg-green-500",
          error: "bg-red-500",
          warning: "bg-yellow-500",
          info: "bg-blue-500",
        }[type];

        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up`;
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-${
              type === "success"
                ? "check-circle"
                : type === "error"
                ? "exclamation-circle"
                : type === "warning"
                ? "exclamation-triangle"
                : "info-circle"
            } mr-2"></i>
            ${message}
          </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Export functionality with enhanced UX
      function exportPeople() {
        showNotification("Preparing export...", "info");

        setTimeout(() => {
          // Simulate export process
          const link = document.createElement("a");
          link.href = "/api/people/export?format=csv";
          link.download = `people_export_${
            new Date().toISOString().split("T")[0]
          }.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          showNotification("Export completed successfully!", "success");
        }, 1000);
      }

      // Enhanced modal functions
      function openPersonDetailsModal(id) {
        // Call the global JS function to fetch and populate person details
        if (window.viewPersonDetails) {
          window.viewPersonDetails(id);
        } else {
          EnhancedModal.show("personDetailsModal");
          showNotification("Loading person details...", "info");
        }
      }

      function editPerson(id) {
        // Use unified modal for editing person
        unifiedPersonModal.openEditMode(id, "people");
      }

      function generateCard(id) {
        // Implementation for generating card
        showNotification("Generating ID card...", "info");
        setTimeout(() => {
          showNotification("ID card generated successfully!", "success");
        }, 2000);
      }

      function addFamilyMember(id) {
        // Implementation for adding family member
        EnhancedModal.show("familyMemberModal");
      }

      function performAdvancedSearch() {
        // Implementation for advanced search
        showNotification("Performing advanced search...", "info");
        setTimeout(() => {
          showNotification("Search completed!", "success");
        }, 1000);
      }

      function clearAdvancedSearch() {
        // Implementation for clearing search
        document.getElementById("advSearchQuery").value = "";
        document.getElementById("advSearchCategory").value = "";
        document.getElementById("advSearchRegistrationStart").value = "";
        document.getElementById("advSearchRegistrationEnd").value = "";
        document.getElementById("advSearchFamilyMembers").checked = false;
        document.getElementById("advSearchWithCards").checked = false;
        document.getElementById("advSearchWithoutCards").checked = false;

        showNotification("Search filters cleared", "info");
      }

      // Auto-refresh data every 2 minutes
      setInterval(() => {
        loadPeopleStats();
        updateLastUpdateTime();
      }, 120000);
    </script>

    <style>
      /* Enhanced styles */
      .stat-card {
        opacity: 1;
      }

      .glass-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Tooltip styles */
      [data-tooltip] {
        position: relative;
      }

      [data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 1;
        transition: opacity 0.3s;
      }

      /* Enhanced table hover effects */
      .enhanced-table tr:hover {
        background: linear-gradient(
          90deg,
          rgba(59, 130, 246, 0.05),
          rgba(139, 92, 246, 0.05)
        );
        transform: scale(1.01);
      }

      /* Loading state for buttons */
      .btn-loading {
        position: relative;
        color: transparent;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      /* Search dropdown styles */
      #personHostResults {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }

      #personHostResults.show {
        display: block;
      }

      .search-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .search-item:hover {
        background-color: #f9fafb;
      }

      .search-item:last-child {
        border-bottom: none;
      }

      /* Animation for fade in */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      /* Host search field container */
      .search-container {
        position: relative;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <%- include('partials/enhanced-modal') %> <%- include('partials/toast') %>
  </body>
</html>
